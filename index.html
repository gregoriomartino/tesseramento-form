<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modulo di Tesseramento</title>
<style>
body { font-family: Arial,sans-serif; background:#f4f4f4; margin:0; padding:0; }
.container { max-width:600px; margin:40px auto; background:#fff; padding:30px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.08); }
h1 { text-align:center; margin-bottom:20px; }
label { display:block; margin-top:15px; font-weight:bold; }
input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
button { width:100%; padding:12px; margin-top:20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:#0056b3; }
#message { text-align:center; margin-top:15px; font-weight:bold; color:green; opacity:0; transition:opacity 0.5s; }
</style>
</head>
<body>

<div class="container">
<h1>Modulo di Tesseramento</h1>

<form id="tesseramentoForm">
<label>Cognome</label><input type="text" name="cognome" required>
<label>Nome</label><input type="text" name="nome" required>
<label>Luogo di nascita</label><input type="text" name="luogo_nascita" required>
<label>Data di nascita</label><input type="date" name="data_nascita" required>
<label>Email</label><input type="email" name="email" required>
<label>Telefono (facoltativo)</label><input type="tel" name="telefono">
<label>Consenso GDPR obbligatorio</label>
<input type="checkbox" name="gdpr_obbligatorio" required> Autorizzo il trattamento dei dati<br>
<label>Consenso promozionale (facoltativo)</label>
<input type="checkbox" name="gdpr_promozionale"> Acconsento alle comunicazioni promozionali<br><br>
<button type="submit">Invia</button>
</form>

<div id="message">✓ Invio riuscito!</div>
</div>

<script>
const SCRIPT_URL = "INSERISCI_QUI_LA_TUA_WEB_APP_URL"; // URL Web App Apps Script

// CSV cumulativo
let csvCumulativo = [["Timestamp","Cognome","Nome","Luogo di nascita","Data di nascita","Email","Telefono","GDPR obbl.","GDPR promozionale"]];

document.getElementById("tesseramentoForm").addEventListener("submit", async function(e){
    e.preventDefault();
    const form = this;

    const dati = {
        cognome: form.cognome.value,
        nome: form.nome.value,
        luogo_nascita: form.luogo_nascita.value,
        data_nascita: form.data_nascita.value,
        email: form.email.value,
        telefono: form.telefono.value,
        gdpr_obbligatorio: form.gdpr_obbligatorio.checked ? "SI" : "NO",
        gdpr_promozionale: form.gdpr_promozionale.checked ? "SI" : "NO"
    };

    // 1️⃣ Invia dati a Google Sheet (FormData)
    const formData = new FormData();
    for (let key in dati) formData.append(key, dati[key]);
    try {
        await fetch(SCRIPT_URL, { method: "POST", body: formData });
        console.log("Dati inviati a Google Sheet");
    } catch(err) {
        console.error("Errore invio Google Sheet", err);
    }

    // 2️⃣ Aggiorna CSV cumulativo
    csvCumulativo.push([
        new Date().toLocaleString(),
        dati.cognome,
        dati.nome,
        dati.luogo_nascita,
        dati.data_nascita,
        dati.email,
        dati.telefono,
        dati.gdpr_obbligatorio,
        dati.gdpr_promozionale
    ]);

    // Crea CSV cumulativo
    const csvContent = csvCumulativo.map(row => row.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    // Scarica CSV cumulativo aggiornato
    const a = document.createElement("a");
    a.href = url;
    a.download = "tesseramento_cumulativo.csv";
    a.click();
    URL.revokeObjectURL(url);

    // Messaggio conferma
    const msg = document.getElementById("message");
    msg.style.opacity = "1";
    setTimeout(()=>msg.style.opacity="0",3000);

    // Reset form
    form.reset();
});
</script>

</body>
</html>
